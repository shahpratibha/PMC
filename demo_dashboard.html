<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Map Template</title>
  <link rel="stylesheet" href="css/dashboard.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.css">
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
  <link rel="stylesheet" href="libs/Leaflet.MousePosition-master/src/L.Control.MousePosition.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" type="text/css"
    href="https://cdn-geoweb.s3.amazonaws.com/esri-leaflet-geocoder/0.0.1-beta.5/esri-leaflet-geocoder.css" />


    <style>
             .filters {
            margin-bottom: 20px;
          
        }
        .filter-group {
            /* margin-bottom: 20px; */
            padding: 10px;
            border: 1px solid gray;
            font-size: 10px;
        }
        .filter-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 12px;
            cursor: pointer;
            position: relative;
        }
        .filter-group input[type="text"] {
            width: 80%;
            padding: 5px;
            margin-bottom: 10px;
            font-size: 10px;
            display: none;
        }
        .filter-group ul {
            list-style-type: none;
            padding: 0;
            display: none;
        }
        .filter-group ul.active,
        .filter-group input[type="text"].active {
            display: block;
            forced-color-adjust: blue;
        }
        .filter-group li {
            margin-bottom: 5px;
        }
      
        .icon-container {
    position:absolute;
    right:1%; 
    top:0%;
    font-size: 15px;
}

/* Style the icon */
.icon-container i {
    color: black; /* Default color */
}
    </style>
</head>

<body>
  <div class="container-fluid">

    <div class="main-content">
      <div class="map-container">
        <button class="toggle-button" id="toggleFilters"><i class="fa-solid fa-filter"></i></button>
        <div id="map"></div>
        <!-- table button -->
        <button id="openTableBtn"><img src="png/dtabasetable.png" alt="" class="tablebtn"></button>

        <!-- table design -->
        <div class="row tabchart">
          <div id="table-container-dashboard" style="position: relative; transition: 0s;">

            <button id="closeTableBtnDashboard" class="close-button">
              <i class="fa-solid fa-minus"
                style="font-weight: bold; margin-top: 3px; margin-right: 5px; width: 10px; position: fixed;"></i>
            </button>

            <p id="tablestats" class="tablestats"
              style="position: fixed; color: darkblue; font-size: 12px;font-weight: bold;  z-index: 9999; margin-top: 45px; margin-left:0px;">

            </p>


            <div
              style="position: absolute; top: 30px;  height:240px; width: 97%; overflow: scroll; scrollbar-width: thin;">
              <table id="workTableDashboard" class="table table-bordered table-hover"
                style=" left: 0px; height:100px; width: 100px; overflow: scroll; ">
                <thead id="thead">
                  <tr>
                    <th>Zone</th>
                    <th>Ward</th>
                    <th>Department</th>
                    <th>Work Type</th>
                    <th>Tender Amount</th>
                    <th>JE Name</th>
                    <th>Contractor Name</th>
                    <th>Project Office</th>
                    <th>Budget Code</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>


            <button id="printButton" onclick="printData()"
              style="position: absolute; top: 0%;  right: 5%; z-index: 999; color: green; font-size: 12px; background-color: transparent; height: 29px; width: 35px;">
              <!-- Changed position to fixed -->
              <i class="fa-solid fa-file-export" style="float: left; top: 0px; left: 400px;"></i>
            </button>
          </div>
        </div>
        <!-- table end -->
        <!-- search bar -->
        <div class="SearchBar">


          <select class="form-select ms-auto" aria-label="Select search category" id="search_type"
            style="border-radius: 10px;border: 2px solid darkblue;">
            <option value="">Select Type</option>
          </select>

          <input class="form-contro ms-2" type="search" placeholder="Search" aria-label="Search"
            id="searchInputDashboard" style=" border-radius: 10px; border: 2px solid darkblue;" />
          <div id="autocompleteSuggestions" class="autocomplete-suggestions"></div>

        </div>
        <!-- search bar -->
      </div>


      <!-- filter start -->
      <div class="filters" id="filters">
        <!-- table stats -->
        <div class="showCount">
          <h5 class="tablestats"> </h5>
        </div>
        <!-- table stats -->

        <h3>Filters</h3>
        <div>
          <div class="filter-group"  onclick="toggleFilter(this)">
            <label>Select Office  <span class="icon-container"><i class="fa-solid fa-angle-down"></i></span></label>
            <input type="text" placeholder="Search" class="filter-input">
            <ul class="select2"  multiple="multiple" id="project_Off">
                <!-- <li><input type="checkbox"> Department 1</li>
                <li><input type="checkbox"> Department 2</li>
                <li><input type="checkbox"> Department 3</li> -->
            </ul>
        </div>
           <div onclick="toggleFilter(this)" class="filter-group">
            <label >Select Year <span class="icon-container"><i class="fa-solid fa-angle-down"></i></span>
                </label>
             <input type="text" placeholder="Search" class="filter-input">
             <ul class="select2"  multiple="multiple" id="project_fi">
             
            </ul>
              
           
          </div>
           <div onclick="toggleFilter(this)" class="filter-group">
            <label >Zone Selection <span class="icon-container"><i class="fa-solid fa-angle-down"></i></span>
                </label>
             <input type="text" placeholder="Search" class="filter-input">
             <ul class="select2"  multiple="multiple" id="zones" onchange="loadAdminWardNameAndFilter();">
             
             </ul>
             
           
          </div>
           <div onclick="toggleFilter(this)" class="filter-group">
            <label > Ward Selection <span class="icon-container"><i class="fa-solid fa-angle-down"></i></span>
                </label>
             <input type="text" placeholder="Search" class="filter-input">
             <ul class="select2"  multiple="multiple" id="admin_ward_name" onchange="loadVillagesAndFilter();">
             
             </ul>
              <!-- <select class="select2 form-control" multiple="multiple" id="admin_ward_name" style="width:100%"
                onchange="loadVillagesAndFilter();">
                <option value=""></option>
              </select> -->
          
          </div>
           <div onclick="toggleFilter(this)" class="filter-group">
            <label > Village Selection <span class="icon-container"><i class="fa-solid fa-angle-down"></i></span>
                </label>
             <input type="text" placeholder="Search" class="filter-input">
             <ul class="select2"  multiple="multiple" id="villages" onchange="loadDepartmentsAndFilter();">
             
             </ul>
              <!-- <select class="form-control select2" multiple="multiple" id="villages" style="width: 100%"
                onchange="loadDepartmentsAndFilter();">
                <option value=""></option>
              </select> -->
            
          </div>
           <div onclick="toggleFilter(this)" class="filter-group">
            <label >Select Department <span class="icon-container"><i class="fa-solid fa-angle-down"></i></span>
                </label>
             <input type="text" placeholder="Search" class="filter-input">
             <ul class="select2"  multiple="multiple" id="villages" onchange="loadDepartmentsAndFilter();">
             
             </ul>
              <!-- <select class="form-control select2" id="departments" style="width:100%" multiple="multiple"
                onchange="loadStagesAndFilter();">
                <option value=""></option>
              </select> -->
           
          </div>
           <div onclick="toggleFilter(this)" class="filter-group">
            <label > Select Project Status <span class="icon-container"><i class="fa-solid fa-angle-down"></i></span>
                </label>
             <input type="text" placeholder="Search" class="filter-input">
             <ul class="select2"  multiple="multiple" id="stage"
             onchange="loadWorkTypesAndFilter();">
             
             </ul>
              <!-- <select class="select2 form-control" multiple="multiple" style="width: 100%" id="stage"
                onchange="loadWorkTypesAndFilter();">
                <option value=""></option>
              </select> -->
           
          </div>
           <div onclick="toggleFilter(this)" class="filter-group">
            <label > Select Work Type <span class="icon-container"><i class="fa-solid fa-angle-down"></i></span>
                </label>
             <input type="text" placeholder="Search" class="filter-input">

              <select class="select2 form-control" multiple="multiple" style="width:100%" id="work_type">
                <option value=""></option>
              </select>
            
          </div>
           <div onclick="toggleFilter(this)" class="filter-group">
            <label > Project Cost <span class="icon-container"><i class="fa-solid fa-angle-down"></i></span>
                </label>
             <input type="text" placeholder="Search By Ward Name" class="filter-input">

              <div class="row">
                <div class="col-md-12">
                  <select class="form-select" id="amount_comparison">
                    <option value="greater_than">Greater Than</option>
                    <option value="less_than">Less Than</option>
                  </select>
                </div>
              </div>
              <div class="row">
                <div class="col-md-12">
                  <input type="text" class="form-control" id="amount_value" placeholder="Enter amount" />
                </div>
              </div>
            
          </div>
           <div onclick="toggleFilter(this)" class="filter-group">
            <label > Date Range Selection <span class="icon-container"><i class="fa-solid fa-angle-down"></i></span>
                </label>
             <input type="text" placeholder="Search By Ward Name" class="filter-input">

              <input type="text" name="" class="form-control" id="date_range" />

            
          </div>
        </div>
      </div>
      <!-- filter end -->
    </div>
  </div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <script src="js/select2.js"></script>
  <script src="js/demo_dashboard.js"></script>
  <script src="js/mainmodal/legend.js"></script>
  <script>


    document.addEventListener('DOMContentLoaded', function () {
      const filters = document.getElementById('filters');
      const map = document.getElementById('map');
      const tableBtn = document.getElementById('openTableBtn');
      const button = document.getElementById('toggleFilters');
      let filtersVisible = false;

      button.addEventListener('click', function () {
        if (!filtersVisible) {
          filters.style.marginLeft = '0';
          filters.style.opacity = '1';
          map.style.width = '79vw';
          button.style.top = "18%";
          button.style.right = 'calc(3vw + 1px)';
          button.innerHTML = '<i class="fa-solid fa-filter-circle-xmark"></i>';
          tableBtn.style.right = 'calc(3vw + 1px)';
          tableBtn.style.top = '27%';
        } else {
          filters.style.marginLeft = '-35vw';
          filters.style.opacity = '0';
          map.style.width = '98vw';
          button.style.top = "18%";
          button.style.right = '40px';
          button.innerHTML = '<i class="fa-solid fa-filter"></i>';
          tableBtn.style.right = '40px';
          tableBtn.style.top = '27%';
        }
        filtersVisible = !filtersVisible;
      });


      // accordation Filter




      // accordation clicking activity


      var acc = document.getElementsByClassName("accordion-header");
      for (var i = 0; i < acc.length; i++) {
        acc[i].addEventListener("click", function () {
          this.classList.toggle("active");
          var panel = this.nextElementSibling;
          if (panel.style.display === "block") {
            panel.style.display = "none";
          } else {
            panel.style.display = "block";
          }
        });
      }
    });

    // ---------------------------------
    // fitToBound-----------------------------------

    function fitbous(filter) {
      var layers = ["pmc:IWMS_point", "pmc:IWMS_line", "pmc:IWMS_polygon"];
      var bounds = L.latLngBounds(); // Initialize an empty LatLngBounds object
      console.log("layerBounds", "layerBounds")
      var processLayer = function (layerName, callback) {
        var urlm =
          "https://iwmsgis.pmc.gov.in/geoserver/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=" +
          layerName +
          "&CQL_FILTER=" +
          filter +
          "&outputFormat=application/json";
        console.log(urlm)
        $.getJSON(urlm, function (data) {
          var geojson = L.geoJson(data);
          var layerBounds = geojson.getBounds();
          console.log(layerBounds, "layerBounds")
          bounds.extend(layerBounds); // Extend the bounds
          callback();
        });
      };

      var layersProcessed = 0;
      layers.forEach(function (layerName) {
        processLayer(layerName, function () {
          layersProcessed++;
          if (layersProcessed === layers.length) {
            // Apply the combined bounds to the map after all layers are processed
            if (bounds.isValid()) {
              map.fitBounds(bounds);
            } else {
              console.error("No valid bounds were found for the layers.");
            }
          }
        });
      });
    }

    // accordation--------------------------------------------------------------

    $(document).ready(function () {
      // loadAllData();
      loadInitialData();
    });
    // ------------


    function loadInitialData() {
      loadAdminWardName();
      loadZones();
      loadVillages();
      loadDepartments();
      loadWorkTypes();
      loadProjectFi();
      loadProjectOff()
      loadStage();
    }

    function filterDataAndDrawMap() {
      var selectedDepartments = $("#departments").val();
      var selectedWorkTypes = $("#work_type").val();
      var selectedZones = $("#zones").val();
      var selectedWards = $("#admin_ward_name").val();
      var selectedVillages = $("#villages").val();
      var selectedProjectFi = $("#project_fi").val();
      var selectedProjectOff = $("#project_Off").val();
      var selectedStage = $("#stage").val();
      var selectedDateRange = $("#date_range").val();
      var selectedAmountComparison = $("#amount_comparison").val();
      var selectedAmountValue = $("#amount_value").val();

      // Check if any filter values are not empty
      if (
        !$.isEmptyObject(selectedDepartments) ||
        !$.isEmptyObject(selectedWorkTypes) ||
        !$.isEmptyObject(selectedZones) ||
        !$.isEmptyObject(selectedWards) ||
        !$.isEmptyObject(selectedVillages) ||
        !$.isEmptyObject(selectedStage) ||
        !$.isEmptyObject(selectedDateRange) ||
        !$.isEmptyObject(selectedAmountValue) ||
        !$.isEmptyObject(selectedProjectFi) ||
        !$.isEmptyObject(selectedProjectOff)
      ) {
        // Filter data based on selected filters
        var filteredData = filterData(
          selectedDepartments, selectedWorkTypes,
          selectedZones, selectedWards, selectedVillages, selectedProjectFi,
          selectedProjectOff, selectedStage,
          selectedDateRange, selectedAmountValue, selectedAmountComparison
        );
      } else {
        console.log("No filters selected. Map will not be drawn.");
      }
    }


    function filterData(
      selectedDepartments,
      selectedWorkTypes,
      selectedZones,
      selectedWards,
      selectedVillages,
      selectedProjectFi,
      selectedProjectOff,
      selectedStage,
      selectedDateRange,
      selectedAmountValue,
      selectedAmountComparison
    ) {
      // Create a filter object to store the CQL filter conditions
      var filter = {};
      // added 11-03-2024

      var filter_for_ward = {};
      var filter_for_zone = {};

      // added 11-03-2024
      // Filter data based on selected filters
      var filteredData = [];

      if (selectedProjectFi.length > 0) {
        filter.project_fi = selectedProjectFi
          .map((projectFi) => `'${projectFi}'`)
          .join(",");
      }
      if (selectedProjectOff.length > 0) {
        filter.Project_Office = selectedProjectOff
          .map((Project_Office) => `'${Project_Office}'`)
          .join(",");
        // console.log(filter.Project_Office ,"filter.Project_Office ")
      }

      if (selectedZones.length > 0) {
        filter.zone = selectedZones.map((zone) => `'${zone}'`).join(",");
      }
      if (selectedWards.length > 0) {
        filter.ward = selectedWards.map((ward) => `'${ward}'`).join(",");
      }

      if (selectedDepartments.length > 0) {
        filter.Department = selectedDepartments
          .map((department) => `'${department}'`)
          .join(",");
      }

      // added 11-03-2024
      if (selectedZones.length > 0) {
        filter_for_zone.zone = selectedZones.map((zone) => `'${zone}'`).join(",");
      }
      if (selectedWards.length > 0) {
        filter_for_ward.ward = selectedWards.map((ward) => `'${ward}'`).join(",");
      }

      // added 11-03-2024

      if (selectedWorkTypes.length > 0) {
        filter.work_type = selectedWorkTypes
          .map((workType) => `'${workType}'`)
          .join(",");
      }

      if (selectedStage.length > 0) {
        filter.stage = selectedStage.map((stage) => `'${stage}'`).join(",");
      }
      if (selectedVillages.length > 0) {
        filter.village = selectedVillages
          .map((village) => `'${village}'`)
          .join(",");
      }

      // Create the CQL filter string from the filter object
      var cqlFilter = Object.entries(filter)
        .map(([key, value]) => `${key} IN (${value})`)
        .join(" AND ");



      var cqlFilter_ward = Object.entries(filter_for_ward)
        .map(([key, value]) => `${key} IN (${value})`)
        .join(" AND ");

      var cqlFilter_zone = Object.entries(filter_for_zone)
        .map(([key, value]) => `${key} IN (${value})`)
        .join(" AND ");


      if (selectedAmountValue && selectedAmountValue.trim() !== "") {
        var amountCondition = `Tender_Amount ${selectedAmountComparison === "greater_than" ? ">" : "<"
          } ${parseFloat(selectedAmountValue)}`;
        // If other filters are applied, append "AND" to the amount condition
        if (cqlFilter !== "") {
          cqlFilter += ` AND ${amountCondition}`;
        } else {
          // Otherwise, use only the amount condition
          cqlFilter = amountCondition;
        }
      }

      var startDate, endDate;
      if (selectedDateRange) {
        var dateRangeParts = selectedDateRange.split(" to ");
        startDate = new Date(dateRangeParts[0]);
        endDate = new Date(dateRangeParts[1]);
      }

      if (selectedDateRange && cqlFilter !== "") {
        cqlFilter += ` AND created_at BETWEEN '${startDate.toISOString()}' AND '${endDate.toISOString()}'`;
      } else if (selectedDateRange) {
        cqlFilter = `created_at BETWEEN '${startDate.toISOString()}' AND '${endDate.toISOString()}'`;
      }


      // ********************added new modification 11-03-2023*******************************************

      console.log(cqlFilter, "layerfilter", cqlFilter_ward, "wardhighlightfilter", cqlFilter_zone, "zonehighlightfilter")

      fitbous(cqlFilter);



      IWMS_point.setParams({
        CQL_FILTER: cqlFilter,
      });

      IWMS_point.addTo(map).bringToFront();

      IWMS_line.setParams({
        CQL_FILTER: cqlFilter,
      });

      IWMS_line.addTo(map).bringToFront();

      IWMS_polygon.setParams({
        CQL_FILTER: cqlFilter,
        // styles: "line",
      });
      // console.log("addded")
      IWMS_polygon.addTo(map).bringToFront();


      if (cqlFilter_ward) {
        ward_boundary.setParams({
          CQL_FILTER: cqlFilter_ward,
          styles: "pmc:Highlight_polygon", // Assuming "pointhighlight" is a predefined style
        }).addTo(map).bringToFront();
      }


      if (cqlFilter_zone) {
        Zone_layer.setParams({
          CQL_FILTER: cqlFilter_zone,
          styles: "pmc:Highlight_Zone", // Assuming "pointhighlight" is a predefined style
        }).addTo(map).bringToFront();
      }


      var layers = ["pmc:IWMS_point", "pmc:IWMS_line", "pmc:IWMS_polygon"];
      var typeName = layers.join(',');

      var geoServerURL =
        "https://iwmsgis.pmc.gov.in//geoserver/pmc/wms?service=WFS&version=1.1.0&request=GetFeature&typeName=" +
        typeName +
        "&outputFormat=application/json&CQL_FILTER=" +
        encodeURIComponent(cqlFilter);

      tableData(typeName, geoServerURL, cqlFilter)



      // ====================================


      return filteredData;
    }


    // check changes
    function loadProjectOff() {
      var select = $("#project_Off");
      select.empty();

      // Function to initialize Select2 dropdown
      function initializeSelect2() {
        select.select2({
          placeholder: 'Search',
          templateResult: function (option) {
            if (!option.id) {
              return option.text;
            }
            var $option = $('<span><input type="checkbox" class="select2-option-checkbox" />' + option.text + "</span>");
            return $option;
          },
          templateSelection: function (option) {
            if (!option.id) {
              return option.text;
            }
            return $('<span><input type="checkbox" class="select2-option-checkbox" checked />' + option.text + "</span>");
          },
          closeOnSelect: false,
          dropdownParent: select.parent(),
          multiple: true,
          dropdownPosition: 'below' // Set the dropdown position below the select box
        });
      }

      // Load Select2 dropdown when accordion item is opened
      $(".accordion-header").on("click", function () {
        initializeSelect2();
        select.select2('open');
      });

      $.getJSON(
        "https://iwmsgis.pmc.gov.in/geoserver/pmc/wms?service=WFS&version=1.1.0&request=GetFeature&typeName=IWMS_point,IWMS_polygon,IWMS_line&propertyName=Project_Office&outputFormat=application/json",
        function (data) {
          var projectFiSet = new Set();

          $.each(data.features, function (index, feature) {
            var project_fi = feature.properties.Project_Office;
            projectFiSet.add(project_fi);
          });

          var uniqueProjectFiSet = Array.from(projectFiSet);

          $.each(uniqueProjectFiSet, function (index, project_fi) {
            select.append(
              $("<option>", {
                value: project_fi,
                text: project_fi,
              })
            );
          });

          // Event listener for select change
          select.on("change", function () {
            loadZones();
            filterDataAndDrawMap();
          });
        }
      );
    }



    // check changes
    // newly added 20/04/2022

    function loadProjectFi() {
      var select = $("#project_fi");
      select.empty();

      $.getJSON(
        "https://iwmsgis.pmc.gov.in/geoserver/pmc/wms?service=WFS&version=1.1.0&request=GetFeature&typeName=IWMS_point,IWMS_polygon,IWMS_line&propertyName=project_fi&outputFormat=application/json",
        function (data) {
          var projectFiSet = new Set();

          $.each(data.features, function (index, feature) {
            var project_fi = feature.properties.project_fi;
            projectFiSet.add(project_fi);
          });

          var uniqueProjectFiSet = Array.from(projectFiSet);

          $.each(uniqueProjectFiSet, function (index, project_fi) {
            select.append(
              $("<option>", {
                value: project_fi,
                text: project_fi,
              })
            );
          });

          if (select.hasClass("select2-hidden-accessible")) {
            select.select2("destroy");
          }
          select.select2({
            placeholder: 'search',
            templateResult: function (option) {
              if (!option.id) {
                return option.text;
              }



              var $option = $(
                '<span><input type="checkbox" class="select2-option-checkbox" />' +
                option.text +
                "</span>"
              );
              return $option;
            },

            templateSelection: function (option) {
              if (!option.id) {
                return option.text;
              }

              return $(
                '<span><input type="checkbox" class="select2-option-checkbox" checked />' +
                option.text +
                "</span>"
              );
            },
            closeOnSelect: false,
            dropdownParent: select.parent(),
            multiple: true,
          });
          // Trigger the opening of the Select2 dropdown when the select button is clicked
          var selectButton = $('#headingOfficeYear button');
          selectButton.on('click', function () {
            select.select2('open');
          });

          select.on("change", function () {
            loadZones();
            filterDataAndDrawMap();
          });
        }
      );
    }

    function loadZones() {
      var select = $("#zones");
      select.empty();

      var project_fi = $("#project_fi").val();

      var geoServerURL =
        "https://iwmsgis.pmc.gov.in/geoserver/pmc/wms?service=WFS&version=1.1.0&request=GetFeature&typeName=IWMS_point,IWMS_polygon,IWMS_line&propertyName=zone&outputFormat=application/json";
      if (project_fi.length > 0) {
        project_fi = project_fi
          .map((projectFi) => `'${projectFi}'`)
          .join(",");

        let cqlFilter = `project_fi  IN (${project_fi})`;
        geoServerURL =
          "https://iwmsgis.pmc.gov.in/geoserver/pmc/wms?service=WFS&version=1.1.0&request=GetFeature&typeName=IWMS_point,IWMS_polygon,IWMS_line&propertyName=zone&outputFormat=application/json&CQL_FILTER=" +
          encodeURIComponent(cqlFilter);
      }

      $.getJSON(geoServerURL, function (data) {
        var zoneSet = new Set();

        $.each(data.features, function (index, feature) {
          var zone = feature.properties.zone;
          zoneSet.add(zone);
        });

        var uniqueZoneSet = Array.from(zoneSet);

        $.each(uniqueZoneSet, function (index, zone) {
          select.append(
            $("<option>", {
              value: zone,
              text: zone,
            })
          );
        });

        if (select.hasClass("select2-hidden-accessible")) {
          select.select2("destroy");
        }

        select.select2({
          placeholder: 'search',
          templateResult: function (option) {
            if (!option.id) {
              return option.text;
            }

            var $option = $(
              '<span><input type="checkbox" class="select2-option-checkbox" />' +
              option.text +
              "</span>"
            );
            return $option;
          },
          templateSelection: function (option) {
            if (!option.id) {
              return option.text;
            }

            return $(
              '<span><input type="checkbox" class="select2-option-checkbox" checked />' +
              option.text +
              "</span>"
            );
          },
          closeOnSelect: false,
          dropdownParent: select.parent(),
          multiple: true,
        });

        // Trigger the opening of the Select2 dropdown when the select button is clicked
        var selectButton = $('#headingZone button');
        selectButton.on('click', function () {
          select.select2('open');
        });
      });
    }

    function loadAdminWardName() {
      var select = $("#admin_ward_name");
      select.empty();
      var project_fi = $("#project_fi").val();
      var zones = $("#zones").val();
      let cqlFilter = "";

      if (project_fi.length > 0) {
        project_fi = project_fi
          .map((projectFi) => `'${projectFi}'`)
          .join(",");
        cqlFilter = `project_fi IN (${project_fi})`;
      }

      if (zones.length > 0) {
        zones = zones.map((zone) => `'${zone}'`).join(",");
        cqlFilter += (cqlFilter ? " AND " : "") + `zone IN (${zones})`;
      }

      var geoServerURL =
        "https://iwmsgis.pmc.gov.in/geoserver/pmc/wms?service=WFS&version=1.1.0&request=GetFeature&typeName=IWMS_point,IWMS_polygon,IWMS_line&propertyName=ward&outputFormat=application/json";



      if (cqlFilter) {
        geoServerURL += "&CQL_FILTER=" + encodeURIComponent(cqlFilter);
      }

      $.getJSON(geoServerURL, function (data) {
        var wardSet = new Set();

        $.each(data.features, function (index, feature) {
          var ward = feature.properties.ward;
          wardSet.add(ward);
        });

        var uniqueWard = Array.from(wardSet);

        $.each(uniqueWard, function (index, ward) {
          select.append(
            $("<option>", {
              value: ward,
              text: ward,
            })
          );
        });

        if (select.hasClass("select2-hidden-accessible")) {
          select.select2("destroy");
        }

        select.select2({
          placeholder: 'search',
          templateResult: function (option) {
            if (!option.id) {
              return option.text;
            }

            var $option = $(
              '<span><input type="checkbox" class="select2-option-checkbox" />' +
              option.text +
              "</span>"
            );
            return $option;
          },
          templateSelection: function (option) {
            if (!option.id) {
              return option.text;
            }

            return $(
              '<span><input type="checkbox" class="select2-option-checkbox" checked />' +
              option.text +
              "</span>"

            );
          },
          closeOnSelect: false,
          dropdownParent: select.parent(),
          multiple: true,

        });
        // Trigger the opening of the Select2 dropdown when the select button is clicked
        var selectButton = $('#headingWard button');
        selectButton.on('click', function () {
          select.select2('open');
        });
      });
    }



    function loadVillages() {
      var select = $("#villages");
      select.empty();

      var project_fi = $("#project_fi").val();
      var zones = $("#zones").val();
      var wards = $("#admin_ward_name").val();
      let cqlFilter = "";

      if (project_fi.length > 0) {
        project_fi = project_fi
          .map((projectFi) => `'${projectFi}'`)
          .join(",");
        cqlFilter = `project_fi IN (${project_fi})`;
      }

      if (zones.length > 0) {
        zones = zones.map((zone) => `'${zone}'`).join(",");
        cqlFilter += (cqlFilter ? " AND " : "") + `zone IN (${zones})`;
      }
      if (wards.length > 0) {
        wards = wards.map((ward) => `'${ward}'`).join(",");
        cqlFilter += (cqlFilter ? " AND " : "") + `ward IN (${wards})`;
      }

      var geoServerURL =
        "https://iwmsgis.pmc.gov.in/geoserver/pmc/wms?service=WFS&version=1.1.0&request=GetFeature&typeName=IWMS_point,IWMS_polygon,IWMS_line&propertyName=village&outputFormat=application/json";



      if (cqlFilter) {
        geoServerURL += "&CQL_FILTER=" + encodeURIComponent(cqlFilter);
      }

      $.getJSON(geoServerURL, function (data) {
        var villageSet = new Set();
        $.each(data.features, function (index, feature) {
          var village = feature.properties.village;
          villageSet.add(village);
        });

        var uniqueVillage = Array.from(villageSet);

        $.each(uniqueVillage, function (index, village) {
          select.append(
            $("<option>", {
              value: village,
              text: village,
            })
          );
        });

        // Destroy the existing Select2 instance, if it exists
        if (select.hasClass("select2-hidden-accessible")) {
          select.select2("destroy");
        }

        // Initialize Select2 with the updated options
        select.select2({
          placeholder: 'search',
          templateResult: function (option) {
            if (!option.id) {
              return option.text;
            }

            var $option = $(
              '<span><input type="checkbox" class="select2-option-checkbox" />' +
              option.text +
              "</span>"
            );
            return $option;
          },
          templateSelection: function (option) {
            if (!option.id) {
              return option.text;
            }

            return $(
              '<span><input type="checkbox" class="select2-option-checkbox" checked />' +
              option.text +
              "</span>"
            );
          },
          closeOnSelect: false,
          dropdownParent: select.parent(),
          multiple: true,
        });


      });
    }

    function loadDepartments() {
      var select = $("#departments");
      select.empty();

      var project_fi = $("#project_fi").val();
      var zones = $("#zones").val();
      var wards = $("#admin_ward_name").val();
      var villages = $("#villages").val();
      let cqlFilter = "";

      if (project_fi.length > 0) {
        project_fi = project_fi
          .map((projectFi) => `'${projectFi}'`)
          .join(",");
        cqlFilter = `project_fi IN (${project_fi})`;
      }

      if (zones.length > 0) {
        zones = zones.map((zone) => `'${zone}'`).join(",");
        cqlFilter += (cqlFilter ? " AND " : "") + `zone IN (${zones})`;
      }
      if (wards.length > 0) {
        wards = wards.map((ward) => `'${ward}'`).join(",");
        cqlFilter += (cqlFilter ? " AND " : "") + `ward IN (${wards})`;
      }
      if (villages.length > 0) {
        villages = villages.map((village) => `'${village}'`).join(",");
        cqlFilter += (cqlFilter ? " AND " : "") + `village IN (${villages})`;
      }

      var geoServerURL =
        "https://iwmsgis.pmc.gov.in/geoserver/pmc/wms?service=WFS&version=1.1.0&request=GetFeature&typeName=IWMS_point,IWMS_polygon,IWMS_line&propertyName=Department&outputFormat=application/json";

      if (cqlFilter) {
        geoServerURL += "&CQL_FILTER=" + encodeURIComponent(cqlFilter);
      }


      $.getJSON(geoServerURL, function (data) {
        var departmentSet = new Set();
        // console.log(data, "data")
        $.each(data.features, function (index, feature) {
          var department = feature.properties.Department;
          departmentSet.add(department);
        });

        var uniqueDepartments = Array.from(departmentSet);

        $.each(uniqueDepartments, function (index, department) {
          select.append(
            $("<option>", {
              value: department,
              text: department,
            })
          );
        });

        if (select.hasClass("select2-hidden-accessible")) {
          select.select2("destroy");
        }

        select.select2({
          placeholder: 'search',
          templateResult: function (option) {
            if (!option.id) {
              return option.text;
            }

            var $option = $(
              '<span><input type="checkbox" class="select2-option-checkbox" />' +
              option.text +
              "</span>"
            );
            return $option;
          },
          templateSelection: function (option) {
            if (!option.id) {
              return option.text;
            }

            return $(
              '<span><input type="checkbox" class="select2-option-checkbox" checked />' +
              option.text +
              "</span>"
            );
          },
          closeOnSelect: false,
          dropdownParent: select.parent(),
          multiple: true,
        });


      });
    }

    function loadStage() {
      var select = $("#stage");
      select.empty();

      var project_fi = $("#project_fi").val();
      var zones = $("#zones").val();
      var wards = $("#admin_ward_name").val();
      var villages = $("#villages").val();
      var departments = $("#departments").val();
      let cqlFilter = "";

      if (project_fi.length > 0) {
        project_fi = project_fi
          .map((projectFi) => `'${projectFi}'`)
          .join(",");
        cqlFilter = `project_fi IN (${project_fi})`;
      }

      if (zones.length > 0) {
        zones = zones.map((zone) => `'${zone}'`).join(",");
        cqlFilter += (cqlFilter ? " AND " : "") + `zone IN (${zones})`;
      }
      if (wards.length > 0) {
        wards = wards.map((ward) => `'${ward}'`).join(",");
        cqlFilter += (cqlFilter ? " AND " : "") + `ward IN (${wards})`;
      }
      if (villages.length > 0) {
        villages = villages.map((village) => `'${village}'`).join(",");
        cqlFilter += (cqlFilter ? " AND " : "") + `village IN (${villages})`;
      }
      if (departments.length > 0) {
        departments = departments
          .map((department) => `'${department}'`)
          .join(",");
        cqlFilter +=
          (cqlFilter ? " AND " : "") + `Department IN (${departments})`;
      }

      var geoServerURL =
        "https://iwmsgis.pmc.gov.in/geoserver/pmc/wms?service=WFS&version=1.1.0&request=GetFeature&typeName=IWMS_point,IWMS_polygon,IWMS_line&propertyName=stage&outputFormat=application/json";


      if (cqlFilter) {
        geoServerURL += "&CQL_FILTER=" + encodeURIComponent(cqlFilter);
      }

      $.getJSON(geoServerURL, function (data) {
        var stageSet = new Set();

        $.each(data.features, function (index, feature) {
          var stage = feature.properties.stage;
          stageSet.add(stage);
        });

        var uniqueStageSet = Array.from(stageSet);

        $.each(uniqueStageSet, function (index, stage) {
          select.append(
            $("<option>", {
              value: stage,
              text: stage,
            })
          );
        });

        if (select.hasClass("select2-hidden-accessible")) {
          select.select2("destroy");
        }

        select.select2({
          placeholder: 'search',
          templateResult: function (option) {
            if (!option.id) {
              return option.text;
            }

            var $option = $(
              '<span><input type="checkbox" class="select2-option-checkbox" />' +
              option.text +
              "</span>"
            );
            return $option;
          },
          templateSelection: function (option) {
            if (!option.id) {
              return option.text;
            }

            return $(
              '<span><input type="checkbox" class="select2-option-checkbox" checked />' +
              option.text +
              "</span>"
            );
          },
          closeOnSelect: false,
          dropdownParent: select.parent(),
          multiple: true,
        });


      });
    }

    function loadWorkTypes() {
      var select = $("#work_type");
      select.empty();

      var project_fi = $("#project_fi").val();
      var zones = $("#zones").val();
      var wards = $("#admin_ward_name").val();
      var villages = $("#villages").val();
      var departments = $("#departments").val();
      var stages = $("#stage").val();
      let cqlFilter = "";

      if (project_fi.length > 0) {
        project_fi = project_fi
          .map((projectFi) => `'${projectFi}'`)
          .join(",");
        cqlFilter = `project_fi IN (${project_fi})`;
      }

      if (zones.length > 0) {
        zones = zones.map((zone) => `'${zone}'`).join(",");
        cqlFilter += (cqlFilter ? " AND " : "") + `zone IN (${zones})`;
      }
      if (wards.length > 0) {
        wards = wards.map((ward) => `'${ward}'`).join(",");
        cqlFilter += (cqlFilter ? " AND " : "") + `ward IN (${wards})`;
      }
      if (villages.length > 0) {
        villages = villages.map((village) => `'${village}'`).join(",");
        cqlFilter += (cqlFilter ? " AND " : "") + `village IN (${villages})`;
      }
      if (departments.length > 0) {
        departments = departments
          .map((department) => `'${department}'`)
          .join(",");
        cqlFilter +=
          (cqlFilter ? " AND " : "") + `Department IN (${departments})`;
      }
      if (stages.length > 0) {
        stages = stages.map((stage) => `'${stage}'`).join(",");
        cqlFilter += (cqlFilter ? " AND " : "") + `stage IN (${stages})`;
      }

      var geoServerURL =
        "https://iwmsgis.pmc.gov.in/geoserver/pmc/wms?service=WFS&version=1.1.0&request=GetFeature&typeName=IWMS_point,IWMS_polygon,IWMS_line&propertyName=work_type&outputFormat=application/json";

      if (cqlFilter) {
        geoServerURL += "&CQL_FILTER=" + encodeURIComponent(cqlFilter);
      }

      $.getJSON(geoServerURL, function (data) {
        var workTypeSet = new Set();

        // Populate the Set with work types
        $.each(data.features, function (index, feature) {
          var workType = feature.properties.work_type;
          workTypeSet.add(workType);
        });

        // Convert the Set to an array
        var uniqueWorkTypes = Array.from(workTypeSet);

        // Populate select options with unique work types
        $.each(uniqueWorkTypes, function (index, workType) {
          select.append(
            $("<option>", {
              value: workType,
              text: workType,
            })
          );
        });

        // Destroy the existing Select2 instance, if it exists
        if (select.hasClass("select2-hidden-accessible")) {
          select.select2("destroy");
        }

        // Initialize Select2 with the updated options
        select.select2({
          placeholder: 'search',
          templateResult: function (option) {
            if (!option.id) {
              return option.text;
            }

            var $option = $(
              '<span><input type="checkbox" class="select2-option-checkbox" />' +
              option.text +
              "</span>"
            );
            return $option;
          },
          templateSelection: function (option) {
            if (!option.id) {
              return option.text;
            }

            return $(
              '<span><input type="checkbox" class="select2-option-checkbox" checked />' +
              option.text +
              "</span>"
            );
          },
          closeOnSelect: false,
          dropdownParent: select.parent(),
          multiple: true,
        });

        // Event listener for change event
        select.on("change", function () {

          filterDataAndDrawMap();
        });
      });
    }

    function drawCoordinatesOnMap(selectedCoordinates) {
      // Assuming you have a Leaflet map instance named 'map'

      // Clear previous layers from the map
      map.eachLayer(function (layer) {
        if (!(layer instanceof L.TileLayer)) {
          map.removeLayer(layer);
        }
      });

      // Loop through each set of coordinates and draw them on the map
      selectedCoordinates.forEach(function (geometry) {
        var type = geometry.type;
        var coordinates = geometry.coordinates;

        coordinates = coordinates.map(function (coord) {
          return [coord[1], coord[0]]; // Swap longitude and latitude
        });

        if (type === "Polygon" || type === "MultiPolygon") {
          // For both polygons and multi-polygons
          var polygon = L.geoJSON(geometry, {
            style: function (feature) {
              return {
                color: "red",
                fillColor: "transparent",
                fillOpacity: 0.1,
              };
            },
          }).addTo(map);

          // Fit the map bounds to the polygon
          map.fitBounds(polygon.getBounds());
        } else if (type === "MultiLineString") {
          // For both LineString and MultiLineString
          var polyline = L.geoJSON(geometry, {
            style: function (feature) {
              return {
                color: "black", // Change color to black for roads
                weight: 5, // Increase weight for road-like appearance
                dashArray: "10, 10", // Add a dash array for a dashed line appearance
              };
            },
          }).addTo(map);

          // Fit the map bounds to the polyline
          map.fitBounds(polyline.getBounds());
        } else if (type === "LineString") {
          // For both LineString and MultiLineString
          var polyline = L.geoJSON(geometry, {
            style: function (feature) {
              return {
                color: "blue", // Change color to black for roads
                weight: 2, // Increase weight for road-like appearance
              };
            },
          }).addTo(map);

          // Fit the map bounds to the polyline
          map.fitBounds(polyline.getBounds());
        }
      });
    }
    // Table------------------------------------



    function tableData(typeName, geoServerURL, cqlFilter) {

      var openTable = $(document).ready(function () {
        // Function to toggle table visibility
        $("#openTableBtn").click(function () {
          var tableContainer = $("#table-container-dashboard");
          var isOpen = tableContainer.css("display") !== "none";
          if (isOpen) {
            tableContainer.hide(); // Hide the table if it's already open
          } else {
            tableContainer.show(); // Show the table if it's closed
          }
        });


        $.getJSON(geoServerURL, function (data) {
          filteredData = data;

          var totalcountofselectedrecords = filteredData.totalFeatures;
          var totalTenderAmount = filteredData.features.reduce(function (total, project) {
            var tenderAmount = parseFloat(project.properties.Tender_Amount);
            return total + (isNaN(tenderAmount) ? 0 : tenderAmount / 100000);
          }, 0);



          var project = data.features;
          const pageSize = 100; // Number of items per page
          let currentPage = 1; // Current page number

          function updateTable(project, page) {
            const tableBody = document.getElementById('workTableDashboard').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';

            const startIndex = (page - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            const currentPageData = project.slice(startIndex, endIndex);

            currentPageData.forEach(project => {
              var tenderAmount = parseFloat(project.properties.Tender_Amount);
              tenderAmount = isNaN(tenderAmount) ? 0 : tenderAmount / 100000;

              const row = `
      <tr data-coordinates='${JSON.stringify(project.geometry)}'>
          <td>${project.properties.zone}</td>
          <td>${project.properties.ward}</td>
          <td>${project.properties.Department}</td>
          <td>${project.properties.Work_Type}</td>
          <td>${tenderAmount}</td>
          <td>${project.properties.Name_of_JE}</td>
          <td>${project.properties.Agency}</td>
          <td>${project.properties.Project_Office}</td> 
          <td>${project.properties.Budget_Code}</td>
          <td>${project.properties.Created_At}</td>
          <td>${project.properties.Work_Completion_Date}</td>
      </tr>`;

              tableBody.insertAdjacentHTML('beforeend', row);
            });

            updatePaginationButtons(project.length);
            const currentPageElement = document.getElementById('currentPage');
            if (currentPageElement) {
              currentPageElement.textContent = currentPage;
            }
          }

          function updatePaginationButtons(totalItems) {
            const totalPages = Math.ceil(totalItems / pageSize);
            const pagination = document.getElementById('paginationControls');
            pagination.innerHTML = '';

            const previousButton = document.createElement('button');
            previousButton.innerHTML = '<i class="fa-solid fa-backward"></i>';
            previousButton.addEventListener('click', () => {
              if (currentPage > 1) {
                currentPage--;
                updateTable(project, currentPage);
              }
            });
            pagination.appendChild(previousButton);

            const pageInfo = document.createElement('P');
            pageInfo.textContent = `Page${currentPage}`;
            pagination.appendChild(pageInfo);

            const nextButton = document.createElement('button');
            nextButton.innerHTML = '<i class="fa-solid fa-forward"></i>';
            nextButton.addEventListener('click', () => {
              if (currentPage < totalPages) {
                currentPage++;
                updateTable(project, currentPage);
              }
            });
            pagination.appendChild(nextButton);
          }

          // Assuming you have an initial call to updateTable with the initial page
          updateTable(project, currentPage);

          $(".tablestats").html(`Total Amount: ${totalTenderAmount.toFixed(2)}L ,
  Total Projects: ${totalcountofselectedrecords}`);

          $("#workTableDashboard tbody").on("click", "tr", function () {
            var coordinatesStr = $(this).data("coordinates");
            var coordinatesObj = coordinatesStr;
            var boundsLayer = L.geoJSON(coordinatesObj, {
              style: {
                fillColor: "blue", // Fill color
                fillOpacity: 0.3, // Fill opacity
                color: "blue", // Border color
                weight: 2, // Border weight
              },
            }).addTo(map); // Add the bounds layer to the map

            var bounds = boundsLayer.getBounds();
            map.fitBounds(bounds).setZoom(17.5);
            setTimeout(function () {
              map.removeLayer(boundsLayer);
            }, 5000); // Remove the bounds layer after 5 seconds (adjust duration as needed)
          });
          // drag and drop
          // $(function () {
          //   $("#table-container-dashboard").draggable();
          // });



          // -----------------------
          var printButton = $("#printButton")
          var tablestats = $("#tablestatss")
          var isClosed = false;


          $("#closeTableBtnDashboard").click(function () {

            var tableContainer = $("#table-container-dashboard");
            tableContainer.hide();

          });


        });

      });

    }
    //close 
// ------accordtion div------------------

       
function toggleFilter(div) {
    const input = div.querySelector('.filter-input');
    const ul = div.querySelector('ul');
    const isActive = input.classList.contains('active');

    // Remove 'active' class from all filter inputs and their associated ul elements
    document.querySelectorAll('.filter-input').forEach(input => {
        input.classList.remove('active');
        input.nextElementSibling.classList.remove('active');
    });

    // If the clicked filter is not active, add 'active' class to it
    if (!isActive) {
        input.classList.add('active');
        ul.classList.add('active');
    }
}

// Function to filter checkboxes based on search input
function filterCheckboxes(input) {
    const filter = input.value.toLowerCase();
    const ul = input.nextElementSibling;
    const li = ul.getElementsByTagName('li');

    for (let i = 0; i < li.length; i++) {
        const text = li[i].textContent || li[i].innerText;
        if (text.toLowerCase().indexOf(filter) > -1) {
            li[i].style.display = "";
        } else {
            li[i].style.display = "none";
        }
    }
}

// Add event listeners to filter inputs
document.querySelectorAll('.filter-input').forEach(input => {
    input.addEventListener('input', function(event) {
        event.stopPropagation(); // Stop event propagation
        filterCheckboxes(this);
    });
    // Stop event propagation for click events on the input element
 input.addEventListener('click', function(event) {
        event.stopPropagation(); // Stop event propagation
    });
      // Stop event propagation for mousedown events on the input element to prevent the div from closing
      input.addEventListener('mousedown', function(event) {
        event.stopPropagation(); // Stop event propagation
    });
});
 
// Add event listeners to checkboxes to stop propagation
document.querySelectorAll('.filter-group input[type="checkbox"]').forEach(checkbox => {
    checkbox.addEventListener('click', function(event) {
        event.stopPropagation(); // Stop event propagation
    });
});
// --------------------

  </script>
</body>

</html>