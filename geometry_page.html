<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>PMC</title>
		<link rel="icon" href="png/pmcjpeg.png" type="image/x-icon" />

		<!-- External CSS -->
		<link rel="stylesheet" href="css/geom.css" />

		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/boxicons@latest/css/boxicons.min.css" />
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" />
		<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" />
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
		<link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
		<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" />
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />

		<!-- External JavaScript -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"></script>
		<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
		<script src="https://unpkg.com/leaflet-ajax/dist/leaflet.ajax.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
		<script src="https://unpkg.com/@turf/turf@6.3.0/turf.min.js"></script>
		<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
		<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.0/jspdf.umd.min.js"></script>
		<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
		<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

		<!-- Leaflet Draw -->
		<script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
	</head>

	<body class="bg-light">
		<img src="png/pmcjpeg.png" alt="" class="logopng1" />
		<div id="content" style="width: 100%" class="container">
			<div id="button-container" class=""></div>

			<section id="map-section" class="">
				<!-- <h2>MARK AREA</h2> -->

				<form class="mt-3" style="overflow: hidden">
					<div style="margin: 0; float: left">
						<h5 class="text-secondary">Preview Map</h5>
					</div>
					<div style="float: right; margin-top: -40px; margin-left: 95%">
						<i
							class="fa-solid fa-print text-primary"
							id="generatePdfBtn"
							onclick="printPage()"
							style="font-size: 25px"
						></i>
					</div>

					<div id="map"></div>

					<a
						class="geopulseaname"
						style="
							color: darkblue;
							position: absolute;
							z-index: 99999;
							bottom: 0.5%;
							right: 0;
							font-weight: bold;
							/* background-color: rgba(173, 216, 230, 0.5); */
							font-size: 10px;
						"
						>@GeoPulse Analytics</a
					>

					<div id="table-container">
						<table
							id="workTable"
							class="table table-bordered table-hover"
							style="width: 100% !important; font-size: 10px"
						>
							<thead></thead>

							<tbody id="workTableData"></tbody>
						</table>
					</div>
				</form>
			</section>
		</div>


<!-- 
		<div style='max-height: 350px; max-height: 250px;'>
			<table style='width:110%;' class='popup-table'>
				<tr>
					<td>works_aa_a</td>
					<td>856</td>
				</tr>
				<tr>
					<td>name_of_wo</td>
					<td>To carry out resurfacing works on various roads under the jurisdiction of Executive Engineer Path
						Zone No. 3 and 4 through Pune Municipal Corporation's Batch Mix Plant. To do works.</td>
				</tr>
				<tr>
					<td>departme_1</td>
					<td>Road</td>
				</tr>
				<tr>
					<td>work_type</td>
					<td>New</td>
				</tr>
				<tr>
					<td>Project_Office</td>
					<td>null</td>
				</tr>
				<tr>
					<td>zone_id</td>
					<td>null</td>
				</tr>
				<tr>
					<td>zone</td>
					<td>D.M.C. Zone 1</td>
				</tr>
				<tr>
					<td>ward</td>
					<td>Yeravada Kalas Dhanori</td>
				</tr>
				<tr>
					<td>tender_amo</td>
					<td>null</td>
				</tr>
				<tr>
					<td>je_name</td>
					<td>Sapna Sahare</td>
				</tr>
				<tr>
					<td>contact_no</td>
					<td>9689931064</td>
				</tr>
				</td>
				</tr>
				<tr>
					<td>Co-Ordinates</td>
					<td>e.latlng</td>
				</tr>
			</table>
		</div> -->
	
	
		<script>
			var map = L.map('map', {}).setView([18.52, 73.895], 12, L.CRS.EPSG4326);

			var googleSat = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
				maxZoom: 20,
				subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
			}).addTo(map);

			function showCoordinatesOnMap(coordinates) {
				for (var i = 0; i < coordinates.length; i++) {
					var marker = L.polyline(coordinates[i]).addTo(map);
					map.fitBounds(marker.getBounds());
				}
			}



			function getQueryParam(param) {
				const urlParams = new URLSearchParams(window.location.search);
				return urlParams.get(param);
			}

			const lastInsertedId = parseInt(getQueryParam('id'));
			const lastInsertedIdConceptual = parseInt(getQueryParam('lastInsertedId'));
			let department = getQueryParam('department');
			$(document).ready(function () {
				$.ajax({
					url: 'APIS/get_geodata.php', // Path to the PHP script
					type: 'GET',
					data: { id: lastInsertedId , department:department },
					dataType: 'json',
					success: function (response) {
						const geometry = response.data;

						let coordinatesData = [];
						if (geometry.type == 'Polygon') {
							// Handle single Polygon

							coordinatesData.push(
								L.polygon(geometry.coordinates[0].map((coord) => [coord[1], coord[0]]))
							);
						} else if (geometry.type === 'MultiPolygon') {
							// Handle MultiPolygon
							geometry.coordinates.forEach((polygonCoords) => {
								coordinatesData.push(L.polygon(polygonCoords[0].map((coord) => [coord[1], coord[0]])));
							});
						} else if (geometry.type === 'LineString') {
							// Handle single LineString
							let coordinates = geometry.coordinates.map((coord) => [coord[1], coord[0]]);
							coordinatesData.push(L.polyline(coordinates, { color: 'red' }));
						} else if (geometry.type === 'MultiLineString') {
							// Handle MultiLineString
							geometry.coordinates.forEach((lineCoords) => {
								let coordinates = lineCoords.map((coord) => [coord[1], coord[0]]);
								coordinatesData.push(L.polyline(coordinates, { color: 'red' }));
							});
						}

			
						// Add polygons to the map and bind popups
						coordinatesData.forEach((polygon) => {
							polygon.addTo(map).bindPopup('Polygon or MultiPolygon');
							polygon.on('click', function (e) {
								e.target.openPopup();
							});
						});

						// Fit the map view to the bounds of the polygons
						if (coordinatesData.length > 0) {
							let bounds = coordinatesData.reduce((bounds, polygon) => {
								return bounds.extend(polygon.getBounds());
							}, L.latLngBounds());
							map.fitBounds(bounds);
						}
					},
					error: function (error) {
						console.error('AJAX request failed:', error);
					},
				});



				$.ajax({
  // url: API_URL + "/process.php", // Path to the PHP script
  url: "APIS/Get_Conceptual_Form.php", // Path to the PHP script
  type: "GET",
  data: { id: lastInsertedIdConceptual },
  dataType: "json",
  success: function (response) {
	$('#table-container').show();
					const formDataFromStorage = response.data;
					console.log(formDataFromStorage);
					let contentData = '<tr>';
					for (const property in formDataFromStorage) {
						contentData += `<tr><th>${property}</th><td>${formDataFromStorage[property]}</td></tr>`;
					}
					contentData += '</tr>';
					$('#workTableData').html(contentData);

  },
  error: function (error) {
    console.error("AJAX request failed:", error);
  },
});

				if (localStorage.getItem('conceptual_form_data')) {
					return;
					$('#table-container').show();
					const formDataFromStorage = JSON.parse(localStorage.getItem('conceptual_form_data'));
					let contentData = '<tr>';
					for (const property in formDataFromStorage) {
						contentData += `<tr><th>${property}</th><td>${formDataFromStorage[property]}</td></tr>`;
					}
					contentData += '</tr>';
					$('#workTableData').html(contentData);
				}
				if (localStorage.getItem('selectCoordinatesData') !== null) {
					let coordinatesData = localStorage.getItem('selectCoordinatesData');
					coordinatesData = JSON.parse(coordinatesData);
					console.log(coordinatesData);
					let polyline;
					console.log(coordinatesData);
					return;
					coordinatesData.forEach(function (feature) {
						if (feature.geometry.type === 'Polygon') {
							let coordinates = feature.geometry.coordinates[0].map((coord) => [coord[1], coord[0]]);
							let polygon = L.polygon(coordinates).addTo(map);

							// Bind popup to the polygon
							polygon.bindPopup(getPopupContent(feature));

							// Listen for click event on polygon to open popup
							polygon.on('click', function (e) {
								e.target.openPopup();
							});
						} else if (feature.geometry.type === 'MultiPolygon') {
							let coordinates = feature.geometry.coordinates[0][0].map((coord) => [coord[1], coord[0]]);
							let polygon = L.polygon(coordinates).addTo(map);

							// Bind popup to the polygon
							polygon.bindPopup(getPopupContent(feature));

							// Listen for click event on polygon to open popup
							polygon.on('click', function (e) {
								e.target.openPopup();
							});
						} else if (
							feature.geometry.type === 'LineString' ||
							feature.geometry.type === 'MultiLineString'
						) {
							console.log(feature);
							let coordinates = feature?.geometry?.coordinates?.map((innerArray) => {
								console.log(innerArray);
								if (Array.isArray(innerArray[1])) {
									return innerArray.map((coord) => [coord[1], coord[0]]);
								} else {
									return [innerArray[1], innerArray[0]];
								}
							});

							if (coordinates.length > 0) {
								let highlightedAreaLayer = L.polyline(coordinates, {
									color: 'red',
									fillColor: 'red',
									fillOpacity: 0.5,
								}).addTo(map);

								// Fit the map view to the bounds of the highlighted area
								map.fitBounds(highlightedAreaLayer.getBounds());

								// Assuming `polyline` was intended to be `highlightedAreaLayer` based on the context
								highlightedAreaLayer.bindPopup(getPopupContent(feature));
								highlightedAreaLayer.on('click', function (e) {
									e.target.openPopup();
								});
							}

							// Listen for click event on highlightedAreaLayer to open popup
						}
					});

					// Fit map bounds
					let bounds = L.latLngBounds(
						coordinatesData.map((feature) => {
							return L.geoJSON(feature).getBounds();
						})
					);
					map.fitBounds(bounds);
				}
			});

			function getPopupContent(feature) {
				// Create and return the HTML content for the popup based on the feature data
				let content = "<div class='popup-table-container'><table>";
				if (localStorage.getItem('conceptual_form_data')) {
					const formDataFromStorage = JSON.parse(localStorage.getItem('conceptual_form_data'));
					for (const property in formDataFromStorage) {
						content += `<tr><td>${property}</td><td>${formDataFromStorage[property]}</td></tr>`;
					}
				} else {
					for (const [key, value] of Object.entries(feature.properties)) {
						content += `<tr><td>${key}</td><td>${value}</td></tr>`;
					}
				}

				content += '</table></div>';
				return content;
			}

// updated code with geoserver


// var map, geojson;
//         // const API_URL = "https://iwmsgis.pmc.gov.in/geopulse/autodcr/";
//         // const API_URL = "http://localhost/Autodcr";

//         // Add Basemap
//         var map = L.map("map", {
//             center: [18.52, 73.89],
//             zoom: 11,
//             minZoom: 10,
//             maxZoom: 18,
//             boxZoom: true,
//             trackResize: true,
//             wheelPxPerZoomLevel: 40,
//             zoomAnimation: true,

//         });


//         // var map = L.map("map", {}).setView([18.52, 73.895], 12, L.CRS.EPSG4326);

//         var googleSat = L.tileLayer(
//             "http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",
//             {
//                 maxZoom: 20,
//                 subdomains: ["mt0", "mt1", "mt2", "mt3"],
//             }
//         ).addTo(map);



//         var Esri_WorldImagery = L.tileLayer(
//             "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
//             {
//                 maxZoom: 20,
//             }
//         );
//         var baseLayers = {};

//         var IWMS_line = L.tileLayer
//             .wms("https://iwmsgis.pmc.gov.in/geoserver/pmc/wms", {
//                 layers: "IWMS_line",
//                 format: "image/png",
//                 transparent: true,
//                 tiled: true,
//                 version: "1.1.0",
//                 // attribution: "Revenue",
//                 opacity: 1,
//             });
//         var IWMS_polygon = L.tileLayer
//             .wms("https://iwmsgis.pmc.gov.in/geoserver/pmc/wms", {
//                 layers: "IWMS_polygon",
//                 format: "image/png",
//                 transparent: true,
//                 tiled: true,
//                 version: "1.1.0",
//                 // attribution: "Revenue",
//                 opacity: 1,
//             });
//         var IWMS_point = L.tileLayer
//             .wms("https://iwmsgis.pmc.gov.in/geoserver/pmc/wms", {
//                 layers: "IWMS_point",
//                 format: "image/png",
//                 transparent: true,
//                 tiled: true,
//                 version: "1.1.0",
//                 // attribution: "Revenue",
//                 opacity: 1,
//             });
//         // .addTo(map);


//         var WMSlayers = {
//             "Esri": Esri_WorldImagery,
//             "Satellite": googleSat,

//             IWMS_line: IWMS_line,
//             IWMS_polygon: IWMS_polygon,
//             IWMS_point: IWMS_point,

//         };
//         var control = new L.control.layers(baseLayers, WMSlayers).addTo(map);
//         control.setPosition('topright');

//         $(document).ready(function () {
//             var urlParams = new URLSearchParams(window.location.search);
//             var villageName = urlParams.get('works_aa_a');
//             filter = "works_aa_a = " + villageName;
//             console.log(villageName, "work id", filter);
//             FitbouCustomiseRevenue(filter)

//             IWMS_line.setParams({
//                 CQL_FILTER: filter,
//                 maxZoom: 19.5,
//                 // styles: "Highlight_polygon"
//             }).addTo(map);
//             IWMS_polygon.setParams({
//                 CQL_FILTER: filter,
//                 maxZoom: 19.5,
//                 // styles: "Highlight_polygon"
//             }).addTo(map);
//             IWMS_point.setParams({
//                 CQL_FILTER: filter,
//                 maxZoom: 19.5,
//                 // styles: "Highlight_polygon"
//             }).addTo(map);


//             getdata(filter)



//             const layerDetails = ["works_aa_a", "name_of_wo", "departme_1", "work_type", "Project_Office", "zone_id", "zone", "ward", "tender_amo", "je_name", "contact_no"]



//             function getdata(filters) {

//                 layers = ["pmc:IWMS_line"];
//                 layers.forEach(function (layerName) {
//                     var urlm =
//                         "https://iwmsgis.pmc.gov.in/geoserver/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=" +
//                         layerName +
//                         "&CQL_FILTER=" +
//                         filter +
//                         "&outputFormat=application/json";
//                     console.log(urlm)
//                     $('#table-container').show();
//                     $.getJSON(urlm, function (data) {
//                         console.log(data, "data")
//                         var htmldata = data.features[0].properties;
//                         console.log(htmldata, "htmldata")
//                         // geojson = L.geoJson(data, {});
                        
//                         let txtk1 = "";
//                         for (let key of layerDetails) {
//                             if (htmldata.hasOwnProperty(key)) {
//                                 let value = htmldata[key];
//                                 txtk1 += "<tr><td>" + key + "</td><td>" + value + "</td></tr>";
//                             }
//                         }

//                         let detaildata1 = "<div style='max-height: 350px; max-height: 250px;'><table  style='width:110%;' class='popup-table' >" + txtk1 + "</td></tr><tr><td>Co-Ordinates</td><td>" + "e.latlng" + "</td></tr></table></div>";
//                         console.log(detaildata1, "detaildata1")
//                         $('#workTableData').html(detaildata1);

//                     })
//                 })


//             };











//         });

//         function FitbouCustomiseRevenue(filter) {
//             layers = ["pmc:IWMS_line", "pmc:IWMS_polygon", "pmc:IWMS_point"];
//             layers.forEach(function (layerName) {
//                 var urlm =
//                     "https://iwmsgis.pmc.gov.in/geoserver/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=" +
//                     layerName +
//                     "&CQL_FILTER=" +
//                     filter +
//                     "&outputFormat=application/json";
//                 $.getJSON(urlm, function (data) {
//                     geojson = L.geoJson(data, {});
//                     map.fitBounds(geojson.getBounds());
//                 });
//             });
//         }










// updated code with geoserver
			$(function () {
				$('#table-container').draggable();
			});
		</script>

		<script>
			function printPage() {
				// Trigger the browser's print dialog
				window.print();
			}
		</script>
	</body>
</html>
